{
    "version": "1.3.4466.51",
    "description": "A free and open source cross platform OpenVPN client.",
    "homepage": "https://client.pritunl.com",
    "license": {
        "identifier": "Freeware",
        "url": "https://github.com/pritunl/pritunl-client-electron/blob/HEAD/LICENSE"
    },
    "suggest": {
        "Microsoft Visual C++ 2015-2022 Redistributable": "extras/vcredist2022"
    },
    "url": "https://github.com/pritunl/pritunl-client-electron/releases/download/1.3.4466.51/Pritunl.exe#/dl.exe",
    "hash": "sha512:704afa0da898efc80aa9897b2cd0d5df8e4732382e0ee5d31461c3d3b80abb68a05a3c6f155039af264619e8a85014c60421400cd75d3d7db512e19040b74f40",
    "innosetup": true,
    "architecture": {
        "64bit": {
            "installer": {
                "script": [
                    "Get-ChildItem -Path $dir -Include '*,2*' -Recurse -File | Remove-Item -Force -ErrorAction SilentlyContinue",
                    "Get-ChildItem -Path $dir -Include '*,1*' -Recurse -File | Rename-Item -NewName { $_.Name -replace ',\\d', '' }"
                ]
            }
        },
        "arm64": {
            "installer": {
                "script": [
                    "Get-ChildItem -Path $dir -Include '*,1*' -Recurse -File | Remove-Item -Force -ErrorAction SilentlyContinue",
                    "Get-ChildItem -Path $dir -Include '*,2*' -Recurse -File | Rename-Item -NewName { $_.Name -replace ',\\d', '' }"
                ]
            }
        }
    },
    "pre_install": "if (-not (is_admin)) { abort \"`n[ERROR]  $app requires admin rights to $cmd.\" }",
    "post_install": [
        "$service_name = 'pritunl'",
        "$path_regex = [regex]::Escape((Split-Path -Path $dir -Parent))",
        "Start-Service -Name $service_name -ErrorAction SilentlyContinue",
        "if ($PSVersionTable.PSVersion -ge [version]::new(6, 0)) {",
        "    $services = Get-Service -Name $service_name -ErrorAction SilentlyContinue",
        "} else {",
        "    $name_filter = \"Name = '$service_name'\"",
        "    $services = Get-CimInstance -ClassName Win32_Service -Filter $name_filter -ErrorAction SilentlyContinue |",
        "            Select-Object -Property *, @{ Name = 'BinaryPathName'; Expression = { $_.PathName } }",
        "}",
        "$service = $services | Where-Object { $_.BinaryPathName -match $path_regex }",
        "if ($service -and @($service.Status, $service.State) -contains 'Running') { return }",
        "if ($service) { abort \"`n[ERROR]  Service '$service_name' exists but failed to start. Installation terminated.\" }",
        "if ($services) {",
        "    Write-Host \"`nINFO  Identified a stale or conflicting service instance. Initiating removal...\" -ForegroundColor DarkGray",
        "    Stop-Service -Name $service_name -Force -ErrorAction SilentlyContinue; Start-Sleep -Milliseconds 1500",
        "    if ($PSVersionTable.PSVersion -ge [version]::new(6, 0)) {",
        "        Remove-Service -Name $service_name -ErrorAction SilentlyContinue",
        "    } else {",
        "        Start-Process -FilePath 'sc.exe' -ArgumentList @('delete', $service_name) -NoNewWindow -Wait",
        "    }",
        "    $timer = [System.Diagnostics.Stopwatch]::StartNew()",
        "    while ($timer.Elapsed.TotalSeconds -lt 16) {",
        "        $current_elapsed = $timer.Elapsed.TotalSeconds",
        "        $percent = [System.Math]::Min(($current_elapsed / 15) * 100, 100)",
        "        $progress_params = @{",
        "            Activity = 'Service Management'; PercentComplete = $percent",
        "            CurrentOperation = \"Elapsed: $current_elapsed s / Timeout: 15 s\"",
        "            Status = \"Waiting for '$service_name' to be fully de-registered...\"",
        "        }",
        "        $check = Get-Service -Name $service_name -ErrorAction SilentlyContinue",
        "        if ($null -eq $check) {",
        "            $progress_params['Status'] = 'Service successfully uninstalled.'",
        "            $progress_params['PercentComplete'] = 100",
        "            $progress_params['Completed'] = $true",
        "            Write-Progress @progress_params",
        "            break",
        "        }",
        "        Write-Progress @progress_params",
        "        Start-Sleep -Milliseconds 2500",
        "    }",
        "    $timer.Stop()",
        "    abort 'Please reboot your computer to complete the uninstallation, then try again.'",
        "}",
        "$service_config = @{",
        "    Name = $service_name",
        "    BinaryPathName = \"`\"$dir\\pritunl-service.exe`\"\"",
        "    DisplayName = 'Pritunl Client Helper Service'",
        "    Description = 'Provides core helper functions for the Pritunl VPN client. Disabling this service will prevent the Pritunl client from functioning correctly.'",
        "    StartupType = 'Automatic'",
        "}",
        "New-Service @service_config | Out-Null",
        "$failure_actions = [byte[]](",
        "    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,",
        "    0x14, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0xb8, 0x0b, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,",
        "    0x88, 0x13, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x88, 0x13, 0x00, 0x00",
        ")",
        "$registry_path = \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\$service_name\"",
        "Set-ItemProperty -Path $registry_path -Name 'FailureActions' -Value $failure_actions",
        "Set-ItemProperty -Path $registry_path -Name 'FailureActionsOnNonCrashFailures' -Value 1",
        "Start-Service -Name $service_name -ErrorAction SilentlyContinue"
    ],
    "bin": [
        "pritunl.exe",
        "pritunl-client.exe"
    ],
    "shortcuts": [
        [
            "pritunl.exe",
            "Pritunl"
        ]
    ],
    "pre_uninstall": "if (-not (is_admin)) { abort \"`n[ERROR]  $app requires admin rights to $cmd.\" }",
    "uninstaller": {
        "script": [
            "Stop-Service -Name 'pritunl' -Force -ErrorAction SilentlyContinue",
            "Stop-Process -Name 'pritunl', 'pritunl-service' -Force -ErrorAction SilentlyContinue",
            "Start-Sleep -Milliseconds 1500",
            "if ($cmd -ne 'uninstall') { return }",
            "if ($PSVersionTable.PSVersion -lt [Version]::new(6, 0)) {",
            "    Start-Process -FilePath 'sc.exe' -ArgumentList @('delete', 'pritunl') -NoNewWindow -Wait",
            "} else {",
            "    Remove-Service -Name 'pritunl' -ErrorAction SilentlyContinue",
            "}"
        ]
    },
    "checkver": {
        "github": "https://github.com/pritunl/pritunl-client-electron"
    },
    "autoupdate": {
        "url": "https://github.com/pritunl/pritunl-client-electron/releases/download/$version/Pritunl.exe#/dl.exe",
        "hash": {
            "url": "https://raw.githubusercontent.com/pritunl/pritunl-client-electron/HEAD/SHA512",
            "regex": "(?s)$version.+?$sha512.+?$basename"
        }
    }
}
